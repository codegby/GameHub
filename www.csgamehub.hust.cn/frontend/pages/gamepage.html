<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameHub - 游戏中心</title>
    <link rel="stylesheet" href="./../css/gamepage.css">
    <link href="./../../src/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="./../../src/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="./../../src/vendor/fontawesome/css/all.min.css">
    <link rel="icon" href="./../../src/images/favicon1.ico" type="image/x-icon">
    <script src="./../../src/vendor/jquery/jquery-3.6.4.min.js"></script>
</head>

<body>
    <div class="my-container" id="background_container">
        <div class="loader-wrapper">
            <span class="loader"><span class="loader-inner"></span></span>
        </div>
        <div class="lefter">
            <img src="./../../src/images/test_icon.webp" alt="" class="profile_pic">
            <p class="username"></p>
            <p class="gamename"></p>
            <p class="history_best"></p>
        </div>

        <div class=" main">
            <div class="my-container" id="screen_container">
                <div class="screen">
                    <div class="item">
                        <span id="score"></span>
                        <!-- <span id="history"></span> -->
                        <button id="btn">New Game</button>
                    </div>
                    <canvas id="canvas"></canvas>
                    <!-- <script src="./../game/2048/js/game.js" id="currentgame"></script> -->
                    <!-- <script src="./../game/senpai/js/game.js"></script> -->
                </div>
            </div>
            <div class="my-container" id="gametable_container">
                <!-- 这里面的元素由init函数插入 -->
            </div>
            <div class="container mt-5">
                <h2 class="mb-4">评论区</h2>

                <!-- 评论输入框和提交按钮 -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form id="commentForm" onsubmit="commentHandle(event)">
                            <div class="form-group">
                                <textarea class="form-control" id="commentText" rows="3" name="comment_text"
                                    placeholder="写点评论..."></textarea>
                            </div>
                            <input type="text" id="ivsb_user_name" name="username" style="display: none;">
                            <input type="text" id="ivsb_game_name" name="gamename" style="display: none;">
                            <button type="submit" class="btn btn-primary">提交</button>
                        </form>
                    </div>
                </div>

                <!-- 评论列表 -->
                <div id="commentList" class="list-group">
                    <!-- 评论项将会动态插入到这里 -->
                </div>
            </div>
        </div>

        <div class="righter">
            <!-- 查看排行榜的小按钮 -->
            <div id="sidebar-trigger" class="sidebar-trigger">
                查看排行榜
            </div>
            <!-- 排行榜侧边栏内容 -->
            <div id="sidebar" class="sidebar">
                <div class="sidebar-content">
                    <table class="table" style="color:white !important;">
                        <thead>
                            <tr>
                                <th scope="col" class="myth">#</th>
                                <th scope="col" class="myth">玩家</th>
                                <th scope="col" class="myth">最高得分</th>
                            </tr>
                        </thead>
                        <tbody class="table-group-divider" id="ranklist">
                            <!-- 这里面是游戏对应的用户排名，由 init_rank_list 插入 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 用于展开/隐藏排行榜右边栏的js代码 -->
            <script>
                const sidebarTrigger = document.getElementById('sidebar-trigger');
                sidebarTrigger.addEventListener('click', () => {
                    // 切换侧边栏状态  
                    document.getElementById('sidebar').classList.toggle('sidebar-open');
                    document.getElementById('sidebar-trigger').classList.toggle('sidebar-trigger-open');
                    if (document.getElementById('sidebar').classList.contains('sidebar-open'))
                        document.getElementById('sidebar-trigger').innerHTML = "收起排行榜";
                    else document.getElementById('sidebar-trigger').innerHTML = "查看排行榜";
                });
            </script>
        </div>
    </div>
</body>

<script>
    var score_ready = false, game_icon_ready = false;
    var score_timer, game_icon_timer;

    function game_icon_click_handle() {
        // event.preventDefault();
        console.log("游戏图标点击事件触发");
        window.location.href = "./gamepage.html?gamename=" + this.name;
    }
    function init() {
        // 游戏列表的生成
        var gametable = document.getElementById("gametable_container");

        //评论区表单用户名和游戏名的初始化
        var user_name = document.getElementById("ivsb_user_name");
        var game_name = document.getElementById("ivsb_game_name");
        user_name.value = localStorage.getItem("username");
        game_name.value = localStorage.getItem("cur_game");

        // 游戏列表的插入
        var game_select_api = "./../../backend/api/game_select_api.php";
        fetch(game_select_api, {
            method: "GET"
        })
            .then(response => response.json())
            .then(data => {
                if (data.code != 0) {
                    alert(data.msg);
                } else {
                    console.log("游戏列表查询成功");
                    console.log(data);
                    var game_icon_ok = new Array(data.data.length).fill(false);
                    for (var i = 0; i < data.data.length; i++) {
                        var new_game_icon_table = document.createElement("div");
                        var new_game_icon = document.createElement("img");
                        new_game_icon.src = "./../../src/images/" + data.data[i] + "_icon.jpg";
                        new_game_icon.name = data.data[i];
                        var new_game_name = document.createElement("p");
                        new_game_icon_table.classList.add("game_icon_table");
                        new_game_icon.classList.add("game_icon");
                        new_game_icon.onclick = game_icon_click_handle;
                        var set_icon_ok = (seq) => { game_icon_ok[seq] = true; }
                        new_game_icon.onload = set_icon_ok(i);
                        new_game_name.classList.add("game_name");
                        new_game_name.innerHTML = data.data[i];
                        new_game_icon_table.appendChild(new_game_icon);
                        new_game_icon_table.appendChild(new_game_name);
                        gametable.appendChild(new_game_icon_table);
                    }
                    game_icon_timer = setInterval(() => {
                        game_icon_ready = game_icon_ok.every(element => element === true);
                        if (game_icon_ready)
                            clearInterval(game_icon_timer);
                    }, 10);
                }
            })
            .catch(error => {
                console.error(error);
            })

        // for (var i = 1; i <= 5; i++) {
        //     var new_game_icon_table = document.createElement("div");
        //     var new_game_icon = document.createElement("img");
        //     new_game_icon.src = "./../../src/images/test_game_icon.webp";
        //     var new_game_name = document.createElement("p");
        //     new_game_icon_table.classList.add("game_icon_table");
        //     new_game_icon.classList.add("game_icon");
        //     new_game_name.classList.add("game_name");
        //     new_game_name.innerHTML = "game" + i;
        //     new_game_icon_table.appendChild(new_game_icon);
        //     new_game_icon_table.appendChild(new_game_name);
        //     gametable.appendChild(new_game_icon_table);
        // }

        // 用户名显示
        document.getElementsByClassName("username")[0].innerHTML = "用户名: " + user_name.value;

        // 游戏名显示
        document.getElementsByClassName("gamename")[0].innerHTML = "正在游玩: " + game_name.value;

        //评论加载
        var comment_list = document.getElementById("commentList");
        var get_comment_api = "./../../backend/api/get_comment_api.php";
        var temp_form_data = new FormData();
        temp_form_data.append("gamename", localStorage.getItem("cur_game"));

        var get_layer_0_comment_api = "./../../backend/api/get_layer0_comment_api..php";
        fetch(get_layer_0_comment_api, {
            method: "POST", //理论上要用GET, 但是这里我还需要传一个gamename, GET方法不能添加body, 所以这里我用了POST方法
            body: temp_form_data
        }).then(response => response.json())
            .then(data => {
                if (data.code != 0) {
                    alert(data.msg);
                } else {
                    console.log("评论查询成功");
                    console.log(data.data);
                    // var usernames = data.data.usernames;
                    // var comments = data.data.comments;
                    // console.assert(usernames.length == comments.length); //不会打断执行, 是true的时候也不会显示在控制台
                    // var len = usernames.length;
                    // for (var i = 0; i < len; i++) {
                    // var new_item = document.createElement("div");
                    // new_item.className = "list-group-item";
                    // new_item.innerHTML = "<h4><strong>" + usernames[i] + ":</strong></h4>" + comments[i];
                    // comment_list.appendChild(new_item);
                    // }
                    for (var i = 0; i < data.data.length; i++) {
                        var new_item = document.createElement("div");
                        new_item.className = "list-group-item";
                        new_item.innerHTML = "<h4><strong>" + data.data[i].username + ":</strong></h4>" + data.data[i].comment;
                        comment_list.appendChild(new_item);
                    }
                }
            })
            .catch(error => {
                console.error(error);
            })
        // 游戏排名加载
        init_rank_list();

        // 历史最佳显示
        // document.getElementsByClassName("history_best")[0].innerHTML = "历史最佳: 0";
        score_timer = setInterval(() => {
            if (game_icon_ready && score_ready) {
                $(".loader-wrapper").fadeOut("slow");
                clearInterval(score_timer);
            }
        }, 10);
    }

    // function game_icon_click_handle(event) {
    //     event.preventDefault();
    //     console.log("事件触发");
    //     // window.location.href = "https://ys.mihoyo.com/";
    //     window.open("https://ys.mihoyo.com/", "_blank");
    // }

    function init_rank_list() {
        event.preventDefault();
        var ranklist = document.getElementById("ranklist");
        var game_rank_api = "./../../backend/api/game_rank_api.php";
        var temp_form_data = new FormData();
        temp_form_data.append("gamename", localStorage.getItem("cur_game"));
        fetch(game_rank_api, {
            method: "POST",
            body: temp_form_data
        }).then(response => response.json())
            .then(data => {
                if (data.code != 0) {
                    alert(data.msg);
                } else {
                    console.log("游戏排名查询成功");
                    console.log(data);
                    var usernames = data.data.usernames;
                    var scores = data.data.highest_scores;
                    console.assert(usernames.length == scores.length); //不会打断执行, 是true的时候也不会显示在控制台
                    var len = usernames.length;
                    for (var i = 0; i < len; i++) {
                        if (usernames[i] == localStorage.getItem("username")) {
                            document.getElementsByClassName("history_best")[0].innerHTML = "历史最佳: " + scores[i];
                            score_ready = true;
                        }
                        var new_item = document.createElement("tr");
                        new_item.innerHTML = "<th scope=\"row\" class=\"myth\">" + crown_style(i + 1) + "</th><td class=\"mytd\">" + usernames[i] + "</td><td class=\"mytd\">" + scores[i] + "</td>";
                        ranklist.appendChild(new_item);
                    }
                    if (document.getElementsByClassName("history_best")[0].innerHTML == '') {
                        document.getElementsByClassName("history_best")[0].innerHTML = "历史最佳: 0";
                        score_ready = true;
                    }
                }
            })
            .catch(error => {
                console.error(error);
            })
    }

    // 前1~3名给予皇冠
    function crown_style(rank) {
        if (rank > 3) return rank;
        return "<i class=\"fa-solid fa-crown\" style=\"color:" + (rank == 1 ? "gold" : (rank == 2 ? "silver" : "rgb(186,110,64)")) + ";\"></i>";
    }
    // window.onload = init();

    var profile_pic = document.getElementsByClassName("profile_pic")[0];
    profile_pic.onclick = function () {
        console.log("头像点击事件触发");
        window.location.href = "./messageCenter.html";
    }

    function commentHandle(event) {
        event.preventDefault();
        console.log("评论区表单被提交了");
        var url = "./../../backend/api/post_comment.php";
        var comment_form = document.getElementById("commentForm");
        var form_data = new FormData(comment_form);
        fetch(url, {
            method: "POST",
            body: form_data
        }).then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.code == 1) {
                    alert(data.msg);
                } else {
                    alert("评论发表成功");
                    location.reload();
                }
            }).catch(error => {
                console.error(error);
            });
    }

    // 动态加载游戏 js
    function loadScript(url, callback) {
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = url;

        // Attach event listener for when the script is loaded  
        script.onload = function () {
            if (callback && typeof callback === 'function') {
                callback();
                init();
            }
        };
        script.onerror = function () {
            // 为了防止玩家故意设置一个错误的url参数导致找不到js，自动跳转到2048
            window.location.href = "./gamepage.html";
        }

        // Append the script to the body  
        document.body.appendChild(script);
    }

    var queryValue = new URLSearchParams(window.location.search).get('gamename');
    if (queryValue == null) queryValue = "2048"; // 默认游戏
    loadScript("./../game/" + queryValue + "/js/game.js", function () {
        console.log(queryValue + " is loaded.");
        localStorage.setItem("cur_game", queryValue);
    })
    function recordScore(score) {
        const update_score_api = "./../../backend/api/update_score_api.php";
        var gameData = new FormData();
        gameData.append("username", localStorage.getItem("username"));
        gameData.append("gamename", localStorage.getItem("cur_game"));
        gameData.append("score", score);

        fetch(update_score_api, {
            method: "POST",
            body: gameData
        })
            .then(response => response.json())
            .then(data => {
                if (data.code != 0) {
                    alert(data.msg);
                } else {
                    console.log("游戏分数更新接口返回结果");
                    console.log(data);
                }
            })
            .catch(error => {
                console.error(error);
            })
    }

    //按道理来说,应该是等页面所有元素加载完成之后才结束动画,但是发现结束动画的时候游戏图标还没有加载出来,所以我设置了一个timeout 1s
    // $(window).on("load", function () {
    //     $(".loader-wrapper").fadeOut("slow");
    // });
</script>

</html>