<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gamepage</title>
    <link rel="stylesheet" href="./../css/gamepage.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</head>

<body>
    <div class="my-container" id="background_container">
        <div class="lefter">
            <img src="./../../src/images/test_icon.webp" alt="" class="profile_pic">
            <p class="username"></p>
            <p class="gamename"></p>
            <p class="history_best">历史最佳: 0</p>
        </div>

        <div class="main">
            <div class="my-container" id="screen_container">
                <div class="screen">
                    <div class="item">
                        <span id="score"></span>
                        <!-- <span id="history"></span> -->
                        <!-- <button id="btn">New Game</button> -->
                    </div>
                    <canvas id="canvas"></canvas>
                    <script src="./../game/2048/js/game.js"></script>
                    <!-- <script src="./../game/senpai/js/game.js"></script> -->
                </div>
            </div>
            <div class="my-container" id="gametable_container">
                <!-- 这里面的元素由init函数插入 -->
            </div>
        </div>

        <div class="righter">
            <h1 class="rank_title">
                排行榜
            </h1>
        </div>

        <div class="container mt-5">
            <h2 class="mb-4">评论区</h2>

            <!-- 评论输入框和提交按钮 -->
            <div class="card mb-4">
                <div class="card-body">
                    <form id="commentForm" onsubmit="commentHandle(event)">
                        <div class="form-group">
                            <textarea class="form-control" id="commentText" rows="3" name="comment_text"
                                placeholder="写点评论..."></textarea>
                        </div>
                        <input type="text" id="ivsb_user_name" name="username" style="display: none;">
                        <input type="text" id="ivsb_game_name" name="gamename" style="display: none;">
                        <button type="submit" class="btn btn-primary">提交</button>
                    </form>
                </div>
            </div>

            <!-- 评论列表 -->
            <div id="commentList" class="list-group">
                <!-- 评论项将会动态插入到这里 -->
            </div>
        </div>
    </div>
</body>

<script>
    function game_icon_click_handle(event) {
        // event.preventDefault();
        console.log("游戏图标点击事件触发");
    }

    function init() {
        // 游戏列表的生成
        var gametable = document.getElementById("gametable_container");

        //评论区表单用户名和游戏名的初始化
        var user_name = document.getElementById("ivsb_user_name");
        var game_name = document.getElementById("ivsb_game_name");
        user_name.value = localStorage.getItem("username");
        game_name.value = localStorage.getItem("cur_game");

        // 游戏列表的插入
        var game_select_api = "./../../backend/api/game_select_api.php";
        fetch(game_select_api, {
            method: "GET"
        })
            .then(response => response.json())
            .then(data => {
                if (data.code != 0) {
                    alert(data.msg);
                } else {
                    console.log("游戏列表查询成功");
                    console.log(data);
                    for (var i = 0; i < data.data.length; i++) {
                        var new_game_icon_table = document.createElement("div");
                        var new_game_icon = document.createElement("img");
                        new_game_icon.src = "./../../src/images/" + data.data[i] + "_icon.jpg";
                        var new_game_name = document.createElement("p");
                        new_game_icon_table.classList.add("game_icon_table");
                        new_game_icon.classList.add("game_icon");
                        new_game_icon.onclick = game_icon_click_handle(event);
                        new_game_name.classList.add("game_name");
                        new_game_name.innerHTML = data.data[i];
                        new_game_icon_table.appendChild(new_game_icon);
                        new_game_icon_table.appendChild(new_game_name);
                        gametable.appendChild(new_game_icon_table);
                    }
                }
            })
            .catch(error => {
                console.error(error);
            })

        // for (var i = 1; i <= 5; i++) {
        //     var new_game_icon_table = document.createElement("div");
        //     var new_game_icon = document.createElement("img");
        //     new_game_icon.src = "./../../src/images/test_game_icon.webp";
        //     var new_game_name = document.createElement("p");
        //     new_game_icon_table.classList.add("game_icon_table");
        //     new_game_icon.classList.add("game_icon");
        //     new_game_name.classList.add("game_name");
        //     new_game_name.innerHTML = "game" + i;
        //     new_game_icon_table.appendChild(new_game_icon);
        //     new_game_icon_table.appendChild(new_game_name);
        //     gametable.appendChild(new_game_icon_table);
        // }

        // 用户名显示
        var username = document.getElementsByClassName("username")[0];
        username.innerHTML = "用户名: " + localStorage.getItem("username");

        // 游戏名显示
        var gamename = document.getElementsByClassName("gamename")[0];
        gamename.innerHTML = "正在游玩: " + "2048";

        //评论加载
        var comment_list = document.getElementById("commentList");
        var get_comment_api = "./../../backend/api/get_comment_api.php";
        var temp_form = document.createElement("form");
        var temp_game_name_input = document.createElement("input");
        temp_game_name_input.value = localStorage.getItem("cur_game");
        temp_game_name_input.name = "gamename";
        temp_form.appendChild(temp_game_name_input);
        var temp_form_data = new FormData(temp_form);
        fetch(get_comment_api, {
            method: "POST", //理论上要用GET, 但是这里我还需要传一个gamename, GET方法不能添加body, 所以这里我用了POST方法
            body: temp_form_data
        }).then(response => response.json())
            .then(data => {
                if (data.code != 0) {
                    alert(data.msg);
                } else {
                    console.log("评论查询成功");
                    console.log(data);
                    var usernames = data.data.usernames;
                    var comments = data.data.comments;
                    console.assert(usernames.length == comments.length); //不会打断执行, 是true的时候也不会显示在控制台
                    var len = usernames.length;
                    for (var i = 0; i < len; i++) {
                        var new_item = document.createElement("div");
                        new_item.className = "list-group-item";
                        new_item.innerHTML = "<h4><strong>" + usernames[i] + ":</strong></h4>" + comments[i];
                        comment_list.appendChild(new_item);
                    }
                }
            })
            .catch(error => {
                console.error(error);
            })
    }

    // function game_icon_click_handle(event) {
    //     event.preventDefault();
    //     console.log("事件触发");
    //     // window.location.href = "https://ys.mihoyo.com/";
    //     window.open("https://ys.mihoyo.com/", "_blank");
    // }

    function init_rank_list() {
        event.preventDefault();
    }

    window.onload = init();

    var profile_pic = document.getElementsByClassName("profile_pic")[0];
    profile_pic.onclick = function () {
        console.log("头像点击事件触发");
        window.location.href = "./messageCenter.html";
    }

    function commentHandle(event) {
        event.preventDefault();
        console.log("评论区表单被提交了");
        var url = "./../../backend/api/post_comment.php";
        var comment_form = document.getElementById("commentForm");
        var form_data = new FormData(comment_form);
        fetch(url, {
            method: "POST",
            body: form_data
        }).then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.code == 1) {
                    alert(data.msg);
                } else {
                    alert("评论发表成功");
                    location.reload();
                }
            }).catch(error => {
                console.error(error);
            });
    }
</script>

</html>