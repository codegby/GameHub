<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./../css/mangerPage.css">
    <link rel="stylesheet" href="./../../src/vendor/bootstrap/css/bootstrap.min.css">
</head>

<body>
    <div class="my-flex-container">
        <div class="my-lefter">
            <div class="my-option-table">
                <p class="my-option" onclick="jumpHandle1(event);">
                    代码审核
                </p>
            </div>
            <div class="my-option-table" style="background-color: #000000;">
                <p class="my-option" onclick="jumpHandle2(event);">
                    账号管理
                </p>
            </div>
        </div>
        <div class="my-main">
            <div class="my-main-header">
                <p class="my-main-header-title">
                    账号管理
                </p>
                <hr>
                <input type="text" class="my-search-box" placeholder="搜索用户名">
                <button class="my-search-btn" onclick="searchHandle(event)">搜索</button>
            </div>
            <div class="my-main-body">
                <table>
                    <!-- <thead>
                        <td>序号</td>
                        <td>用户名</td>
                        <td>操作</td>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Njaso</td>
                            <td>
                                <a href="">修改</a>
                                <a href="">删除</a>
                            </td>
                        </tr>
                    </tbody> -->
                </table>
            </div>
            <div class="my-main-bottom my-flex-container">
                <div class="my-page-navigation-table">
                    <button class="my-page-btn">上一页</button>
                    <button class="my-page-btn" style="background-color: #00A1D6; color:white;">1</button>
                    <button class="my-page-btn">2</button>
                    <button class="my-page-btn">3</button>
                    <!-- <button class="my-page-btn my-omit-btn">...</button> -->
                    <span style="font-size: 20px; color: #aaa;">...</span>
                    <button class="my-page-btn">114514</button>
                    <button class="my-page-btn">下一页</button>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    function jumpHandle1(event) {
        event.preventDefault();
        location.href = './codeReview.html';
    }

    function jumpHandle2(event) {
        event.preventDefault();
        location.href = './accountManager_root.html';
    }

    function deleteUsernameHandle(event) {
        event.preventDefault();
        var yes = confirm("你确定要删除该用户吗?");
        if (yes == false) {
            return;
        }
        const delete_username_api = "./../../backend/api/delete_username_api.php";
        var form_data = new FormData();
        var event_target = event.target;
        var username = "";
        var this_tr = event_target.parentNode.parentNode;
        for (var child of this_tr.childNodes) {
            if (child.id == 'my-special-td') {
                username = child.innerHTML;
                break;
            }
        }
        form_data.append("username", username);
        fetch(delete_username_api, {
            method: "POST",
            body: form_data
        })
            .then(response => response.json())
            .then(data => {
                if (data.code != 0) {
                    alert(data.msg);
                }
                else {
                    console.log("用户删除成功");
                    var this_tr_parent = this_tr.parentNode;
                    this_tr_parent.removeChild(this_tr);
                }
            })
            .catch(error => console.error(error));
    }

    function generateEmptyTable(msg) {
        var my_table = document.getElementsByTagName("table")[0];
        // 先将子节点全部删除
        var table_children = my_table.childNodes;
        while (table_children.length > 0) {
            my_table.removeChild(table_children[0]);
        }
        var my_thead = document.createElement("thead");
        var only_tr = document.createElement("tr");
        var only_td = document.createElement("td");
        only_td.className = "my-only-td";
        only_td.innerHTML = msg;
        only_tr.appendChild(only_td);
        my_thead.appendChild(only_tr);
        my_table.appendChild(my_thead);
    }

    function generateTable(usernames) {
        var my_table = document.getElementsByTagName("table")[0];
        // 先将子节点全部删除
        var table_children = my_table.childNodes;
        while (table_children.length > 0) {
            my_table.removeChild(table_children[0]);
        }

        var my_thead = document.createElement("thead");
        var my_id_td = document.createElement("td");
        var my_username_td = document.createElement("td");
        var my_operation_td = document.createElement("td");
        my_id_td.innerHTML = "序号";
        my_username_td.innerHTML = "用户名";
        my_operation_td.innerHTML = "操作";
        my_thead.appendChild(my_id_td);
        my_thead.appendChild(my_username_td);
        my_thead.appendChild(my_operation_td);
        my_table.appendChild(my_thead);



        var my_tbody = document.createElement("tbody");

        for (var i = 0; i < usernames.length; i++) {
            var new_tr = document.createElement("tr");
            var new_id_td = document.createElement("td");
            var new_username_td = document.createElement("td");
            new_username_td.id = "my-special-td";

            var new_operation_td = document.createElement("td");
            var new_operation_modify_a = document.createElement("a");
            new_operation_modify_a.innerHTML = "修改 ";
            new_operation_modify_a.href = "#";
            var new_operation_delete_a = document.createElement("a");
            new_operation_delete_a.innerHTML = "删除";
            new_operation_delete_a.href = "#";
            new_operation_delete_a.onclick = deleteUsernameHandle;
            new_operation_td.appendChild(new_operation_modify_a);
            new_operation_td.appendChild(new_operation_delete_a);

            new_id_td.innerHTML = i + 1;
            new_username_td.innerHTML = usernames[i];

            new_tr.appendChild(new_id_td);
            new_tr.appendChild(new_username_td);
            new_tr.appendChild(new_operation_td);

            my_tbody.appendChild(new_tr);
        }

        my_table.appendChild(my_tbody);
    }

    function searchHandle(event) {
        event.preventDefault();
        const select_likely_username_api = "./../../backend/api/select_likely_username_api.php";
        var search_box = document.getElementsByClassName("my-search-box")[0];
        var form_data = new FormData();
        form_data.append("part_username", search_box.value);
        fetch(select_likely_username_api, {
            method: "POST",
            body: form_data,
        })
            .then(response => response.json())
            .then(data => {
                if (data.code != 0) {
                    alert(data.msg);
                }
                else {
                    console.log("用户名查询成功");
                    if (data.data.length != 0) {
                        generateTable(data.data);
                    }
                    else {
                        generateEmptyTable("没有搜索到相关结果");
                    }
                }
            })
    }

    function init() {
        const select_username_api = "./../../backend/api/select_username_api.php";
        fetch(select_username_api, {
            method: "GET",
        })
            .then(response => response.json())
            .then(data => {
                if (data.code != 0) {
                    alert(data.msg);
                } else {
                    console.log("用户名查询成功");
                    if (data.data.length == 0) {
                        generateEmptyTable("当前用户表为空");
                    } else {
                        generateTable(data.data);

                    }
                }
            })
            .catch(error => console.error(error));
    }

    window.onload = init();

</script>

</html>