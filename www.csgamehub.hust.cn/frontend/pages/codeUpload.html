<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameHub - 创作中心</title>
    <link rel="stylesheet" href="./../css/personalCenter.css">
    <link rel="stylesheet" href="./../css/codeUpload.css">
    <link href="./../../src/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="./../../src/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="./../../src/vendor/fontawesome/css/all.min.css">
    <link rel="icon" href="./../../src/images/favicon1.ico" type="image/x-icon">
    <script src="./../../src/vendor/jquery/jquery-3.6.4.min.js"></script>
    <link rel="stylesheet" href="./../css/global.css">
</head>

<body>
    <div class="loader-wrapper">
        <span class="loader"><span class="loader-inner"></span></span>
    </div>
    <div class="my-flex-container" id="background_container">
        <div class="lefter">
            <div style="height: 30%; place-items: center; display: grid;">
                <img src="./../../src/images/test_icon.webp" alt="" class="profile_pic">
            </div>
            <div class="option" onclick="jumpHandle1(event)">
                <p>消息中心</p>
            </div>
            <div class="option" style="background-color: #ccc;" onclick="jumpHandle2(event)">
                <p>创作中心</p>
            </div>
            <div class="option" onclick="jumpHandle3(event)">
                <p>账号管理</p>
            </div>
            <a href="./gamepage.html">
                <div class="option">返回首页</div>
            </a>
        </div>
        <div class="main" style="background-image: none;">
            <div class="header">
                <div>
                    <h2 style="margin-top: 40px;margin-bottom: 40px;display: inline-block;">上传附件</h2>
                    <p style="color:gray;margin-bottom: 40px;display: inline-block;margin-left: 40px;">
                        将所需文件上传至项目中，即可提交你的 canvas 游戏作品！</p>
                </div>
                <input type="file" id="fileInput" style="display:none;" multiple>
                <div class="drop-zone" id="dropZone">
                    <i class="fa-solid fa-cloud-arrow-up"
                        style="font-size: 100px;transition: background-color 1s ease-in-out;"></i>
                    <p style="margin-top: 20px;transition: background-color 1s ease-in-out;">将文件拖放到这里或点击上传</p>
                </div>
                <div>
                    <ul class="list-group list-group-flush" id="uploadedFiles">
                    </ul>
                </div>
                <button class="btn btn-danger" id="clearAllButton">取消所有已选择文件</button>
                <button class="btn btn-success" id="submitButton" style="margin-left: 20px;">提交文件</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const uploadedFilesDiv = document.getElementById('uploadedFiles');
        const fileInput = document.getElementById('fileInput');
        const uploadText = dropZone.querySelector("p");
        const uploadImg = dropZone.querySelector("i");
        const hoverHTML = "松开鼠标以上传文件";
        const blurHTML = "将文件拖放到这里或点击上传";
        var currentFilesMap = new Map();

        dropZone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropZone.classList.add('hover');
            uploadText.classList.add('blue-fade');
            uploadImg.classList.add('blue-fade');
            uploadText.innerHTML = hoverHTML;
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('hover');
            uploadText.classList.remove('blue-fade');
            uploadImg.classList.remove('blue-fade');
            uploadText.innerHTML = blurHTML;
        });

        dropZone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropZone.classList.remove('hover');
            uploadText.classList.remove('blue-fade');
            uploadImg.classList.remove('blue-fade');
            uploadText.innerHTML = blurHTML;
            const files = event.dataTransfer.files;
            handleFiles(files);
        });

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (event) => {
            const files = event.target.files;
            handleFiles(files);
        });


        function fileSize(size) {
            size = parseFloat(size);
            if (size <= 1000)
                return size.toFixed(2) + 'B';
            else if (size <= 1000000)
                return (size / 1024).toFixed(2) + 'KB';
            else if (size <= 1000000000)
                return (size / 1024 / 1024).toFixed(2) + 'MB';
            else if (size <= 1024 * 1024 * 1024)
                return (size / 1024 / 1024 / 1024).toFixed(2) + 'GB';
            else return ">1GB";
        }

        function handleFiles(files) {
            for (const file of files) {
                currentFilesMap.set(file.name, file);
                const fileItem = document.createElement('li');
                fileItem.className = 'list-group-item';
                fileItem.innerHTML = "<div style=\"margin-right:20px;display:inline-block;\">" + file.name + "</div><div style=\"color:gray;display:inline-block;\">" + fileSize(file.size) + "</div>";

                const cancelButton = document.createElement('button');
                cancelButton.textContent = '取消选择';
                cancelButton.style = "float:right;";
                cancelButton.classList.add('btn');
                cancelButton.classList.add('btn-outline-danger');
                cancelButton.onclick = (e) => {
                    e.stopPropagation();
                    uploadedFilesDiv.removeChild(fileItem);
                    currentFilesMap.delete(file.name);
                }
                fileItem.appendChild(cancelButton);
                uploadedFilesDiv.appendChild(fileItem);
            }
            fileInput.value = "";
        }

        document.getElementById('clearAllButton').onclick = () => {
            uploadedFilesDiv.innerHTML = '';
            currentFilesMap = new Map();
        };

        document.getElementById('submitButton').onclick = () => {
            if (currentFilesMap.size === 0) {
                alert("请先上传文件！");
                return;
            }
            const formData = new FormData();
            currentFilesMap.forEach((value, key) => {
                formData.append("file[]", value);
            })

            fetch('../../backend/api/upload.php', {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(data => {
                    console.log(data);
                    alert("文件已提交给管理员审核！");
                })
                .catch(error => {
                    console.error('上传失败:', error);
                    alert("文件上传失败，请重试！");
                });
        };

        function jumpHandle1(event) {
            event.preventDefault();
            window.location.href = "./messageCenter.html";
        }

        function jumpHandle2(event) {
            event.preventDefault();
            window.location.href = "./codeUpload.html";
        }

        function jumpHandle3(event) {
            event.preventDefault();
            window.location.href = "./accountManager.html";
        }
        $(window).on("load", function () {
            $(".loader-wrapper").fadeOut("slow");
        });
    </script>
</body>

</html>